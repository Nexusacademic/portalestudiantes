<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal del Estudiante | Nexus Chess</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/xTd0NgKW/NEXUS-CHESS-BLANCO.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 10px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            color: #64748b; 
            transition: all 0.2s;
            position: relative;
            cursor: default;
        }

        .status-present { background-color: #10b981; color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); } 
        .status-late { background-color: #f59e0b; color: white; box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3); } 
        .status-absent { background-color: #ef4444; color: white; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3); } 

        .sidebar-link { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .sidebar-link:hover, .sidebar-link.active { background-color: rgba(255,255,255,0.05); border-left-color: #3b82f6; color: white; }
        
        .upload-zone.dragover { background-color: #eff6ff; border-color: #3b82f6; border-style: solid; }
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
    </style>
</head>
<body class="text-slate-600 h-screen overflow-hidden flex flex-col antialiased selection:bg-blue-600 selection:text-white">

    <div id="login-screen" class="fixed inset-0 z-[60] flex bg-white">
        <div class="hidden lg:flex lg:w-1/2 relative bg-slate-900 overflow-hidden items-center justify-center">
            <div class="absolute inset-0 opacity-40">
                <img src="https://images.unsplash.com/photo-1529699211952-734e80c4d42b?q=80&w=2071&auto=format&fit=crop" class="w-full h-full object-cover">
            </div>
            <div class="absolute inset-0 bg-gradient-to-tr from-slate-900 via-slate-900/80 to-blue-900/40"></div>
            <div class="relative z-10 text-center p-12">
                <div class="w-32 h-32 mx-auto mb-8 bg-white/10 backdrop-blur-md rounded-3xl flex items-center justify-center border border-white/10 shadow-2xl">
                    <img src="https://i.postimg.cc/7ZMDp79f/LOGO-PNG-NEXUS-CHESS-sin-letras.png" class="w-20 h-20 object-contain drop-shadow-md">
                </div>
                <h1 class="text-5xl font-bold text-white font-oswald tracking-wide mb-4">NEXUS CHESS</h1>
                <p class="text-blue-200 text-lg max-w-md mx-auto leading-relaxed">Domina el tablero. Con√©ctate con tu futuro.</p>
            </div>
        </div>

        <div class="w-full lg:w-1/2 flex items-center justify-center p-8 bg-slate-50">
            <div class="w-full max-w-md bg-white p-10 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 fade-in">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-slate-900">Bienvenido de nuevo</h2>
                    <p class="text-slate-500 text-sm mt-1">Ingresa tus credenciales para acceder al aula.</p>
                </div>
                <form id="login-form" class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-2">C√≥digo de Estudiante</label>
                        <input type="text" id="login-code" placeholder="Ej: NX-AIDU" class="w-full pl-4 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wide mb-2">Contrase√±a</label>
                        <input type="password" id="login-pass" placeholder="Tu DNI" class="w-full pl-4 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium">
                    </div>
                    <div id="login-error" class="hidden p-3 rounded-lg bg-red-50 text-red-600 text-xs font-bold">Credenciales incorrectas</div>
                    <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg transition-all">Ingresar al Portal</button>
                </form>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden flex h-full bg-[#f8fafc] relative">
        <aside id="app-sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-300 flex flex-col h-full lg:translate-x-0 transition-transform duration-300">
             <div class="h-20 flex items-center gap-3 px-6 border-b border-slate-800">
                <img src="https://i.postimg.cc/7ZMDp79f/LOGO-PNG-NEXUS-CHESS-sin-letras.png" class="w-8 h-8 brightness-0 invert">
                <span class="font-bold text-white font-oswald text-xl tracking-wider">NEXUS CHESS</span>
            </div>
            <div class="flex-1 py-6 px-3 space-y-1">
                <button onclick="showSection('home')" id="nav-home" class="sidebar-link active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium">Dashboard</button>
                <button onclick="showSection('tasks')" id="nav-tasks" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium">Tareas</button>
            </div>
            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full py-2 rounded-lg bg-slate-800 text-slate-400 text-xs font-bold uppercase">Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full lg:ml-64 relative">
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8">
                <div class="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-full border border-emerald-100">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span class="text-xs font-bold uppercase tracking-wide">Estado: Activo</span>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8">
                <div id="section-home" class="max-w-6xl mx-auto space-y-8 fade-in">
                    <h2 class="text-3xl font-bold font-oswald">¬°Hola, <span id="welcome-name">Campe√≥n</span>! üëã</h2>
                </div>

                <div id="section-tasks" class="hidden max-w-5xl mx-auto fade-in space-y-6">
                    <div class="bg-white rounded-2xl p-8 border border-slate-100 shadow-sm">
                        <h2 class="text-2xl font-bold text-slate-800 font-oswald">Mis Tareas</h2>
                        <p class="text-slate-500 text-sm">Sube tus evidencias reales aqu√≠.</p>
                    </div>
                    <div id="tasks-container" class="space-y-4"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // TU CONFIGURACI√ìN OFICIAL
        const firebaseConfig = {
            apiKey: "AIzaSyB_JqJuavM7TBvnuWtFW55wxqFSWMxrk3Q",
            authDomain: "nexus-chess-base-general.firebaseapp.com",
            databaseURL: "https://nexus-chess-base-general-default-rtdb.firebaseio.com",
            projectId: "nexus-chess-base-general",
            storageBucket: "nexus-chess-base-general.firebasestorage.app",
            messagingSenderId: "521727118362",
            appId: "1:521727118362:web:0ac3549eec2a67009595a3",
            measurementId: "G-44QJGQQ2FC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        window.systemData = null;
        window.currentUser = null;
        window.selectedFiles = {};

        // Escucha de datos
        onValue(ref(db, 'academy_v1'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                window.systemData = data;
                checkSession(); 
            }
        });

        // --- FUNCI√ìN DE SUBIDA CORREGIDA: TOKEN AUTOM√ÅTICO ---
        window.uploadTaskFiles = async function(taskId) {
            const files = window.selectedFiles[taskId];
            if (!files || files.length === 0) return;

            const btn = document.getElementById(`btn-upload-${taskId}`);
            const progressBar = document.getElementById(`progress-bar-${taskId}`);
            const progressFill = document.getElementById(`progress-fill-${taskId}`);

            btn.disabled = true;
            btn.innerHTML = `Enviando...`;
            progressBar.classList.remove('hidden');
            
            // Usamos el c√≥digo del alumno (NX-AIDU) para las rutas
            const studentCode = window.currentUser.discountCode || `STU-${window.currentUser.id}`;
            const classId = window.currentUser.assignedClassId;
            let uploadedFiles = [];

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `hw_${Date.now()}_${i}.jpg`;
                    
                    // 1. Ruta f√≠sica en Storage
                    const fileRef = storageRef(storage, `homework_uploads/${studentCode}/${taskId}/${fileName}`);
                    
                    // 2. Subida real
                    const snapshot = await uploadBytes(fileRef, file);
                    
                    // 3. OBTENCI√ìN AUTOM√ÅTICA DEL TOKEN (URL)
                    const url = await getDownloadURL(snapshot.ref);
                    
                    uploadedFiles.push({ url, name: file.name });
                    progressFill.style.width = `${((i + 1) / files.length) * 100}%`;
                }

                // 4. Guardado en Base de Datos
                // IMPORTANTE: Guardamos 'fileUrl' para que tu p√°gina admin lo lea directamente
                const submissionPath = `academy_v1/tasks/${classId}/${taskId}/submissions/${window.currentUser.id}`;
                await update(ref(db, submissionPath), {
                    status: 'ENTREGADO',
                    files: uploadedFiles,
                    fileUrl: uploadedFiles[0].url, // Link que abrir√° el bot√≥n "Ver Imagen" del admin
                    timestamp: Date.now(),
                    studentName: window.currentUser.studentName
                });

                delete window.selectedFiles[taskId];
                alert("¬°Tarea entregada con √©xito!");
                renderTasks();

            } catch (error) {
                console.error("Error cr√≠tico:", error);
                alert("Error de permisos. Verifica las reglas de Firebase.");
                btn.disabled = false;
                btn.innerHTML = `Reintentar`;
            } finally {
                progressBar.classList.add('hidden');
            }
        }

        // Funciones auxiliares (Login, Secciones, Renderizado) se mantienen igual a tu l√≥gica original
        window.handleFileSelect = (e, taskId) => {
            window.selectedFiles[taskId] = Array.from(e.target.files);
            const btn = document.getElementById(`btn-upload-${taskId}`);
            btn.disabled = false;
            btn.classList.replace('bg-slate-200', 'bg-blue-600');
            btn.classList.replace('text-slate-400', 'text-white');
        };

        window.renderTasks = function() {
            const container = document.getElementById('tasks-container');
            const classId = window.currentUser.assignedClassId;
            const tasks = window.systemData.tasks?.[classId] || {};
            container.innerHTML = '';

            Object.keys(tasks).forEach(taskId => {
                const t = tasks[taskId];
                const sub = t.submissions?.[window.currentUser.id];
                const status = sub ? sub.status : 'PENDIENTE';

                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-2xl border border-slate-200 shadow-sm mb-4";
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold">${t.title}</h3>
                        <span class="text-xs font-bold px-2 py-1 rounded bg-slate-100">${status}</span>
                    </div>
                    ${status === 'PENDIENTE' ? `
                        <div class="mt-4">
                            <input type="file" id="file-${taskId}" class="hidden" multiple onchange="handleFileSelect(event, '${taskId}')">
                            <button onclick="document.getElementById('file-${taskId}').click()" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50">Seleccionar Fotos</button>
                            <div id="progress-bar-${taskId}" class="hidden w-full bg-slate-100 h-2 rounded-full mt-2 overflow-hidden">
                                <div id="progress-fill-${taskId}" class="bg-blue-600 h-full w-0 transition-all"></div>
                            </div>
                            <button id="btn-upload-${taskId}" onclick="uploadTaskFiles('${taskId}')" class="w-full mt-3 bg-slate-200 text-slate-400 font-bold py-3 rounded-xl disabled" disabled>Enviar Tarea</button>
                        </div>
                    ` : `<p class="text-xs text-blue-600 font-bold mt-3">‚úì Tarea enviada correctamente</p>`}
                `;
                container.appendChild(card);
            });
        };

        window.handleLogin = (e) => {
            e.preventDefault();
            const code = document.getElementById('login-code').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const student = window.systemData.students?.find(s => (s.discountCode || `STU-${s.id}`) === code && s.guardianDni === pass);
            if (student) {
                localStorage.setItem('nexus_student_session', student.id);
                initDashboard(student);
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.checkSession = () => {
            const sid = localStorage.getItem('nexus_student_session');
            if (sid && window.systemData.students) {
                const s = window.systemData.students.find(x => x.id == sid);
                if (s) initDashboard(s);
            }
        };

        function initDashboard(student) {
            window.currentUser = student;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('welcome-name').innerText = student.studentName;
            renderTasks();
        }

        window.showSection = (id) => {
            document.getElementById('section-home').classList.add('hidden');
            document.getElementById('section-tasks').classList.add('hidden');
            document.getElementById(`section-${id}`).classList.remove('hidden');
        };

        window.logout = () => { localStorage.removeItem('nexus_student_session'); location.reload(); };
        document.getElementById('login-form').addEventListener('submit', window.handleLogin);
        lucide.createIcons();
    </script>
</body>
</html>
